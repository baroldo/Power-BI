// ===============================
// GroupValue Measure
// ===============================
GroupValue =
SWITCH(
    SELECTEDVALUE('GroupBySelector'[GroupBySelector], "All"),
    "INDUSTRY", MAX('MARGIN_DECILIES'[INDUSTRY]),
    "PROD_CAT", MAX('MARGIN_DECILIES'[PROD_CAT]),
    "SECTOR_DESC", MAX('MARGIN_DECILIES'[SECTOR_DESC]),
    "All", "All"
)


// ===============================
// Pareto_RankedTable Measure
// ===============================
Pareto_RankedTable =
VAR CurrentPercentile = MAX('PercentileAxis'[Percentage of Merchants (%)])
VAR BaseTable =
    ADDCOLUMNS(
        ALLSELECTED('MARGIN_DECILIES'),
        "GroupValue", 
            SWITCH(
                SELECTEDVALUE('GroupBySelector'[GroupBySelector], "All"),
                "INDUSTRY", 'MARGIN_DECILIES'[INDUSTRY],
                "PROD_CAT", 'MARGIN_DECILIES'[PROD_CAT],
                "SECTOR_DESC", 'MARGIN_DECILIES'[SECTOR_DESC],
                "All", "All"
            )
    )
VAR RankedTable =
    ADDCOLUMNS(
        BaseTable,
        "Rank", RANKX(BaseTable, [CustomerPercentileRankIncremental], , ASC, DENSE)
    )
VAR FilteredTable =
    FILTER(RankedTable, [Rank] <= CurrentPercentile)
RETURN
    FilteredTable


// ===============================
// Pareto Cumulative Margin by Group Measure
// ===============================
Pareto Cumulative Margin by Group =
VAR FilteredTable = [Pareto_RankedTable]
RETURN
    CALCULATE(
        SUMX(FilteredTable, 'MARGIN_DECILIES'[Margin_$]),
        REMOVEFILTERS('PercentileAxis')
    )
