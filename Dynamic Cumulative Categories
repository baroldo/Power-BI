DynamicCumulativeMarginPercent_BySelectedCategory =
VAR CurrentPercentile = MAX('PercentileAxis'[Value])

-- Step 1: Detect which field is selected in the parameter
VAR SelectedField =
    SELECTEDVALUE('CategorySelector'[CategorySelector])

-- Step 2: Build the dynamic category context based on the selected field
VAR CategoryTable =
    SWITCH(
        TRUE(),
        ISINSCOPE('YourTable'[Category]), 
            FILTER(ALLSELECTED('YourTable'), 'YourTable'[Category] = SELECTEDVALUE('YourTable'[Category])),
        ISINSCOPE('YourTable'[Region]), 
            FILTER(ALLSELECTED('YourTable'), 'YourTable'[Region] = SELECTEDVALUE('YourTable'[Region])),
        ISINSCOPE('YourTable'[Segment]), 
            FILTER(ALLSELECTED('YourTable'), 'YourTable'[Segment] = SELECTEDVALUE('YourTable'[Segment])),
        -- fallback if none match
        ALLSELECTED('YourTable')
    )

-- Step 3: Add percentile ranking within this category
VAR RankedTable =
    ADDCOLUMNS(
        CategoryTable,
        "CustomerPercentile",
        ROUND(
            DIVIDE(
                RANKX(
                    CategoryTable,
                    CALCULATE(SUM('YourTable'[MARGIN_$])),
                    ,
                    DESC,
                    Dense
                ),
                COUNTROWS(CategoryTable)
            ) * 100,
            0
        )
    )

-- Step 4: Cumulative margin up to current percentile
VAR CumulativeMargin =
    SUMX(
        FILTER(RankedTable, [CustomerPercentile] <= CurrentPercentile),
        'YourTable'[MARGIN_$]
    )

-- Step 5: Total margin for current category group
VAR TotalMargin =
    SUMX(CategoryTable, 'YourTable'[MARGIN_$])

RETURN
    DIVIDE(CumulativeMargin, TotalMargin)