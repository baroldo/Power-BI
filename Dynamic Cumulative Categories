DynamicCumulativeMarginPercent_BySelectedCategory =
VAR CurrentPercentile = MAX('PercentileAxis'[Value])

-- Get the selected category group (e.g., a value like "Retail" if [Segment] is selected)
VAR SelectedGroup = SELECTEDVALUE('CategorySelector'[CategorySelector])

-- Create a table of the current category group using TREATAS
VAR CategoryTable =
    CALCULATETABLE(
        ALLSELECTED('YourTable'),
        TREATAS(
            VALUES('YourTable'[Customer]),  -- Key column to retain filtering
            VALUES('YourTable'[Customer])   -- Repeat for identity
        )
    )

-- Add ranking by margin within selected group
VAR RankedTable =
    ADDCOLUMNS(
        CategoryTable,
        "CustomerPercentile",
        ROUND(
            DIVIDE(
                RANKX(
                    CategoryTable,
                    CALCULATE(SUM('YourTable'[MARGIN_$])),
                    ,
                    DESC,
                    Dense
                ),
                COUNTROWS(CategoryTable)
            ) * 100,
            0
        )
    )

-- Calculate cumulative margin within selected group
VAR CumulativeMargin =
    SUMX(
        FILTER(RankedTable, [CustomerPercentile] <= CurrentPercentile),
        'YourTable'[MARGIN_$]
    )

-- Calculate total margin for selected group
VAR TotalMargin =
    SUMX(CategoryTable, 'YourTable'[MARGIN_$])

RETURN
    DIVIDE(CumulativeMargin, TotalMargin)