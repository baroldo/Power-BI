DynamicCumulativeMarginPercent = 
VAR CurrentPercentile = MAX('PercentileAxis'[Percentage of Merchants (%)])

-- Step 1: Base data context (filtered by slicers & current legend group)
VAR BaseTable = 
    ALLSELECTED(MARGIN_DECILIES)

-- Step 2: Determine which field is being used in the legend
VAR GroupedTable =
    SWITCH(
        TRUE(),
        ISINSCOPE(MARGIN_DECILIES[Category]), 
            FILTER(BaseTable, MARGIN_DECILIES[Category] = SELECTEDVALUE(MARGIN_DECILIES[Category])),
        ISINSCOPE(MARGIN_DECILIES[Segment]), 
            FILTER(BaseTable, MARGIN_DECILIES[Segment] = SELECTEDVALUE(MARGIN_DECILIES[Segment])),
        ISINSCOPE(MARGIN_DECILIES[Region]), 
            FILTER(BaseTable, MARGIN_DECILIES[Region] = SELECTEDVALUE(MARGIN_DECILIES[Region])),
        BaseTable
    )

-- Step 3: Add Margin column per customer
VAR CustomerMargins =
    ADDCOLUMNS(
        GroupedTable,
        "Margin", MARGIN_DECILIES[MARGIN_$]
    )

-- Step 4: Rank customers by margin within group
VAR RankedTable =
    ADDCOLUMNS(
        CustomerMargins,
        "CustomerPercentile",
        ROUND(
            DIVIDE(
                RANKX(CustomerMargins, [Margin], , DESC, DENSE),
                COUNTROWS(CustomerMargins)
            ) * 100,
            0
        )
    )

-- Step 5: Cumulative sum up to percentile
VAR CumulativeMargin =
    SUMX(
        FILTER(RankedTable, [CustomerPercentile] <= CurrentPercentile),
        [Margin]
    )

-- Step 6: Total margin for this group
VAR TotalMargin =
    SUMX(RankedTable, [Margin])

RETURN
    DIVIDE(CumulativeMargin, TotalMargin)