DynamicCumulativeMarginPercent = 
VAR CurrentPercentile = MAX('PercentileAxis'[Percentage of Merchants (%)])

-- This returns the currently selected group value (from the field parameter legend)
VAR CurrentGroup = SELECTEDVALUE('GroupBySelector'[GroupBySelector])

-- Step 1: Get all data within the current group and slicer context
VAR GroupedTable =
    ALLSELECTED(MARGIN_DECILIES)

-- Step 2: Add customer-level margin
VAR CustomerMargins =
    ADDCOLUMNS(
        GroupedTable,
        "Margin", SUM(MARGIN_DECILIES[MARGIN_$])
    )

-- Step 3: Rank customers within this group by margin
VAR RankedTable =
    ADDCOLUMNS(
        CustomerMargins,
        "CustomerPercentile",
        ROUND(
            DIVIDE(
                RANKX(CustomerMargins, [Margin], , DESC, DENSE),
                COUNTROWS(CustomerMargins)
            ) * 100,
            0
        )
    )

-- Step 4: Cumulative margin up to current percentile
VAR CumulativeMargin =
    SUMX(
        FILTER(RankedTable, [CustomerPercentile] <= CurrentPercentile),
        [Margin]
    )

-- Step 5: Total margin for this group
VAR TotalMargin =
    SUMX(RankedTable, [Margin])

RETURN
    DIVIDE(CumulativeMargin, TotalMargin)