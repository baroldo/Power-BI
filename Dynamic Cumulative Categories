DynamicCumulativeMarginPercent_DynamicCategory =
VAR CurrentPercentile = MAX('PercentileAxis'[Percentage of Merchants (%)])

-- Get the current group column used in the visual (via field parameter)
-- We don’t SELECT anything directly — we rely on row context and partitioning

-- Step 1: Use all data respecting slicers and current legend group
VAR RankedTable =
    ADDCOLUMNS(
        ALLSELECTED(MARGIN_DECILIES),
        "Margin", MARGIN_DECILIES[MARGIN_$]
    )

-- Step 2: Add rank and percentile by margin within the group (using EARLIER-style context)
VAR GroupedRanked =
    ADDCOLUMNS(
        RankedTable,
        "CustomerPercentile",
        VAR ThisGroup = 
            SELECTCOLUMNS(RankedTable, [GroupBySelector])  -- placeholder; will work via visual context
        RETURN
            ROUND(
                DIVIDE(
                    RANKX(
                        FILTER(
                            RankedTable,
                            [GroupBySelector] = EARLIER([GroupBySelector])
                        ),
                        [Margin],
                        ,
                        DESC,
                        DENSE
                    ),
                    COUNTROWS(
                        FILTER(
                            RankedTable,
                            [GroupBySelector] = EARLIER([GroupBySelector])
                        )
                    )
                ) * 100,
                0
            )
    )

-- Step 3: Calculate cumulative margin up to current percentile
VAR CumulativeMargin =
    SUMX(
        FILTER(
            GroupedRanked,
            [CustomerPercentile] <= CurrentPercentile
        ),
        [Margin]
    )

-- Step 4: Total margin for the group
VAR TotalMargin =
    SUMX(GroupedRanked, [Margin])

RETURN
    DIVIDE(CumulativeMargin, TotalMargin)