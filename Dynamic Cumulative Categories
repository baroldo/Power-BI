DynamicCumulativeMarginPercent = 
VAR CurrentPercentile = MAX('PercentileAxis'[Percentage of Merchants (%)])

-- Step 1: Detect which field is selected via ISFILTERED
VAR UseCategory = ISFILTERED(MARGIN_DECILIES[Category])
VAR UseRegion   = ISFILTERED(MARGIN_DECILIES[Region])
VAR UseSegment  = ISFILTERED(MARGIN_DECILIES[Segment])

-- Step 2: Get the name of the active group column
VAR GroupColumn =
    SWITCH(
        TRUE(),
        UseCategory, "Category",
        UseRegion, "Region",
        UseSegment, "Segment",
        BLANK()
    )

-- Step 3: Add virtual column with group values dynamically
VAR BaseTable =
    ADDCOLUMNS(
        ALLSELECTED(MARGIN_DECILIES),
        "GroupValue",
        SWITCH(
            GroupColumn,
            "Category", MARGIN_DECILIES[Category],
            "Region",   MARGIN_DECILIES[Region],
            "Segment",  MARGIN_DECILIES[Segment]
        ),
        "Margin", MARGIN_DECILIES[MARGIN_$]
    )

-- Step 4: Rank customers by margin within their group
VAR RankedTable =
    ADDCOLUMNS(
        BaseTable,
        "CustomerPercentile",
        VAR ThisGroup = [GroupValue]
        RETURN
            ROUND(
                DIVIDE(
                    RANKX(
                        FILTER(BaseTable, [GroupValue] = ThisGroup),
                        [Margin],
                        ,
                        DESC,
                        DENSE
                    ),
                    COUNTROWS(FILTER(BaseTable, [GroupValue] = ThisGroup))
                ) * 100,
                0
            )
    )

-- Step 5: Cumulative margin for current group and percentile
VAR CumulativeMargin =
    SUMX(
        FILTER(RankedTable, [CustomerPercentile] <= CurrentPercentile),
        [Margin]
    )

VAR TotalMargin =
    SUMX(RankedTable, [Margin])

RETURN
    DIVIDE(CumulativeMargin, TotalMargin)