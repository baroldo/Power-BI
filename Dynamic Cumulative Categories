DynamicCumulativeMarginPercent_ByCategory = 
VAR CurrentPercentile = MAX('PercentileAxis'[Percentage of Merchants (%)])

-- Detect current category from the legend context
VAR CurrentCategory = SELECTEDVALUE(MARGIN_DECILIES[Category])

-- Filter only rows from the current category and selection context
VAR CategoryTable =
    FILTER(
        ALLSELECTED(MARGIN_DECILIES),
        MARGIN_DECILIES[Category] = CurrentCategory
    )

-- Add Margin column if needed
VAR CustomerMargins =
    ADDCOLUMNS(
        CategoryTable,
        "Margin", MARGIN_DECILIES[MARGIN_$]
    )

-- Rank customers by margin within current category
VAR RankedTable =
    ADDCOLUMNS(
        CustomerMargins,
        "CustomerPercentile",
        ROUND(
            DIVIDE(
                RANKX(CustomerMargins, [Margin], , DESC, DENSE),
                COUNTROWS(CustomerMargins)
            ) * 100,
            0
        )
    )

-- Calculate cumulative margin up to current percentile
VAR CumulativeMargin =
    SUMX(
        FILTER(RankedTable, [CustomerPercentile] <= CurrentPercentile),
        [Margin]
    )

-- Total margin for this category
VAR TotalMargin =
    SUMX(RankedTable, [Margin])

RETURN
    DIVIDE(CumulativeMargin, TotalMargin)